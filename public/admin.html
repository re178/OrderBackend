<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
  h1 { text-align:center; color: #333; }
  .card { max-width: 1100px; margin: 0 auto 20px; background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.06); }
  .row { display: grid; gap: 12px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  table { width:100%; border-collapse: collapse; margin-top: 12px; background: white; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; vertical-align: top; }
  th { background:#007BFF; color:white; }
  button { padding:8px 12px; margin:2px; cursor:pointer; border-radius:8px; border: none; }
  .btn { background:#007BFF; color:#fff; }
  .btn-danger { background:#e53935; color:#fff; }
  input, textarea { width: 100%; padding: 8px; border:1px solid #ccc; border-radius: 8px; }
  .hidden { display:none; }
  .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; }
</style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- Login Card -->
  <div id="loginCard" class="card">
    <h2>Admin Login</h2>
    <div class="row">
      <input type="password" id="adminPassword" placeholder="Enter admin password" />
      <button class="btn" onclick="login()">Login</button>
      <p id="loginMsg" style="color:#e53935;"></p>
    </div>
  </div>

  <!-- Dashboard Card -->
  <div id="dashCard" class="card hidden">
    <div class="topbar">
      <div>
        <button class="btn" onclick="downloadPDF()">Download All Orders PDF</button>
        <button class="btn" id="lockBtn" onclick="toggleOrders()">Lock/Unlock Orders</button>
        <button class="btn-danger" onclick="logout()">Logout</button>
        <button class="btn" style="margin-top:8px;" onclick="downloadVisitorPDF()">Download Visitor PDF</button>
      </div>
      <small id="statusText"></small>
    </div>

    <h2>Orders List</h2>
    <table id="visitorsTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Page</th>
      <th>IP</th>
      <th>Time</th>
      <th>Browser</th>
      <th>OS</th>
      <th>Platform</th>
    </tr>
  </thead>
  <tbody><tr><td colspan="7">Loading…</td></tr></tbody>
</table>




    <!-- Visitor Stats -->
    <div class="card" style="margin-top:16px;">
      <h2>Visitor Stats</h2>
      <table id="visitorsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Page</th>
            <th>IP</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="grid-2" style="margin-top: 16px;">
      <div>
        <h3>Send Email to One Client</h3>
        <input type="email" id="singleEmail" placeholder="Client email" />
        <input type="text" id="emailSubject" placeholder="Subject" />
        <textarea id="emailMessage" placeholder="Message (supports HTML)"></textarea>
        <button class="btn" onclick="sendEmail()">Send Email</button>
      </div>

      <div>
        <h3>Send Email to All Clients</h3>
        <input type="text" id="allSubject" placeholder="Subject" />
        <textarea id="allMessage" placeholder="Message (supports HTML)"></textarea>
        <button class="btn" onclick="sendEmailAll()">Send to All</button>
      </div>
    </div>
  </div>

<script>
const API = '/admin/api';
function getToken(){ return localStorage.getItem('admintoken'); }
function setToken(t){ localStorage.setItem('admintoken', t); }
function clearToken(){ localStorage.removeItem('admintoken'); }

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

async function login(){
  const password = document.getElementById('adminPassword').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.textContent = '';
  try{
    const res = await fetch(`${API}/login`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ password })
    });
    if(!res.ok){ msg.textContent = 'Invalid password'; return; }
    const data = await res.json();
    setToken(data.token);
    document.getElementById('adminPassword').value = '';
    await refreshUI();
  }catch(e){
    msg.textContent = 'Network error';
  }
}

function logout(){
  clearToken();
  refreshUI();
}

async function authFetch(url, options={}){
  const token = getToken();
  const headers = Object.assign({ 'Authorization': 'Bearer ' + token }, options.headers || {});
  const merged = Object.assign({}, options, { headers });
  return fetch(url, merged);
}

async function fetchOrders(){
  const res = await authFetch(`${API}/orders-data`);
  if(!res.ok) throw new Error('Auth fail or server error');
  return res.json();
}

// === DELETE ORDER ===
async function deleteOrder(index){
  if(!confirm('Are you sure you want to delete this order?')) return;
  const res = await authFetch(`${API}/order/${index}`, { method:'DELETE' });
  if(!res.ok){ alert('Delete failed'); return; }
  loadOrders();
}

// === DOWNLOAD PDF ===
function downloadPDF(){
  const token = getToken();
  authFetch(`${API}/orders/pdf`).then(async res=>{
    if(!res.ok){ alert('Cannot download'); return; }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'orders.pdf'; a.click();
    URL.revokeObjectURL(url);
  });
}

// === SEND EMAILS ===
async function sendEmail(){
  const email = document.getElementById('singleEmail').value.trim();
  const subject = document.getElementById('emailSubject').value.trim();
  const message = document.getElementById('emailMessage').value.trim();
  const res = await authFetch(`${API}/email-client`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ email, subject, message })
  });
  alert(await res.text());
}

async function sendEmailAll(){
  const subject = document.getElementById('allSubject').value.trim();
  const message = document.getElementById('allMessage').value.trim();
  const res = await authFetch(`${API}/email-all`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ subject, message })
  });
  alert(await res.text());
}

// === VISITOR STATS ===
async function fetchVisitors() {
  try {
    const res = await authFetch(`${API}/get-visits`);
    if(!res.ok) throw new Error('Failed to get visitors');
    const visitors = await res.json();
    const tbody = document.querySelector('#visitorsTable tbody');
    tbody.innerHTML = '';
    if(visitors.length === 0){
      tbody.innerHTML = '<tr><td colspan="4">No visitors yet.</td></tr>';
      return;
    }
    visitors.forEach((v,i) => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${i+1}</td>
    <td>${v.page}</td>
    <td>${v.ip}</td>
    <td>${new Date(v.time).toLocaleString()}</td>
    <td>${v.browser || '-'}</td>
    <td>${v.os || '-'}</td>
    <td>${v.platform || '-'}</td>
  `;
  tbody.appendChild(tr);
});

    });
  } catch(e){
    console.log('Visitor fetch error', e);
  }
}

// === LOCK / UNLOCK ORDERS ===
async function toggleOrders() {
  const btn = document.getElementById('lockBtn');
  try {
    const locked = btn.dataset.locked === 'true';
    const url = locked ? `${API}/unlock-orders` : `${API}/lock-orders`;
    const res = await authFetch(url, { method:'POST' });
    const data = await res.json();
    btn.dataset.locked = data.locked;
    btn.textContent = data.locked ? 'Unlock Orders' : 'Lock Orders';
    alert('Orders ' + (data.locked ? 'locked' : 'unlocked'));
  } catch(e){ alert('Failed to toggle orders'); }
}

// === REJECT ORDER ===
async function rejectOrder(index){
  if(!confirm('Are you sure you want to reject this order?')) return;
  try{
    const res = await authFetch(`${API}/reject-order/${index}`, { method:'POST' });
    alert(await res.text());
    loadOrders();
  } catch(e){ alert('Failed to reject order'); }
}

// === LOAD ORDERS WITH REJECT BUTTON ===
async function loadOrders(){
  const tbody = document.querySelector('#ordersTable tbody');
  tbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
  try{
    const orders = await fetchOrders();
    tbody.innerHTML = '';
    if(orders.length === 0){
      tbody.innerHTML = '<tr><td colspan="8">No orders yet.</td></tr>';
      return;
    }
    orders.forEach(order => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.index + 1}</td>
        <td>${order.fullname}</td>
        <td>${order.email}</td>
        <td>${order.category}</td>
        <td>${order.requirements}</td>
        <td>${order.file ? '<a href="/uploads/'+order.file+'" target="_blank">Download</a>' : 'No file'}</td>
        <td>${new Date(order.date).toLocaleString()}</td>
        <td>
          <button class="btn-danger" onclick="deleteOrder(${order.index})">Delete</button>
          <button class="btn-danger" style="background:#e69138;" onclick="rejectOrder(${order.index})">Reject</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){
    tbody.innerHTML = '<tr><td colspan="8">Auth required or server error.</td></tr>';
  }
}

// === REFRESH UI ===
async function refreshUI(){
  const token = getToken();
  const loginCard = document.getElementById('loginCard');
  const dashCard  = document.getElementById('dashCard');
  const statusTxt = document.getElementById('statusText');

  if(token){
    hide(loginCard);
    show(dashCard);
    statusTxt.textContent = 'Logged in';
    loadOrders();
    fetchVisitors();
    // Initial lock button text
    const btn = document.getElementById('lockBtn');
    btn.dataset.locked = 'false';
    btn.textContent = 'Lock Orders';
  } else {
    show(loginCard);
    hide(dashCard);
    statusTxt.textContent = '';
  }
}

refreshUI();
  // === DOWNLOAD VISITOR PDF ===
function downloadVisitorPDF(){
  authFetch(`${API}/visits/pdf`).then(async res=>{
    if(!res.ok){ alert('Cannot download visitor PDF'); return; }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'visitors.pdf'; a.click();
    URL.revokeObjectURL(url);
  });
}

</script>
</body>
</html>

